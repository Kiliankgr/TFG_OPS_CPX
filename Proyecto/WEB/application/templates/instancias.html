{% extends "layout.html" %}
{% block content %}
<!-- Evitamos que se muestre radio pero manteniendo la funcionalidad (hovering del elemento seleccionado) -->
<style>
  input[type="radio"] {
      display: none;
  }

  /* Estilos para el contenedor con desplazamiento */
  #columna_instancias {
      
      height: 100%;
      overflow: scroll; /* oculta desborde general */
      max-height: 615px;
      overflow-y: auto;
  }
  #columna_instancias .scrollable-content {
    overflow-y: scroll;
    height: 100%; 
  }

  #columna_contenido_instancias {
    overflow-y: auto;
  }
  #content-section_intancias{
    
    min-height: 400px;
  }
  #contenido_instancia{
    height: max-content;
    min-height: 400px;
  }
  #form_group_contenido{
    height: max-content;
  }


</style>

<div class="container mt-5">
    <h2 class="mb-4">Instancias</h2>
    <div class="col">
    <div class="row">
      
      <div class="col-md-4" id="columna_instancias">
        
        <div class="btn-group btn-group-toggle" data-toggle="buttons" style="width:100%">
          <ul class="list-group" style="width:100%">
            {% for instancia in instancias %}
              <!--Transformamos el diccionario de la instancia a JSON, <ignorar aviso de error>-->
              <article class="btn btn-info active mb-2" id="instancia_elemento" onclick='seleccionarInstancia({{ instancia | tojson | safe }})'>
                <input type="radio" name="options" autocomplete="off">
                <div class="media-body">
                  <div class="article-metadata">                              
                    <small class="text-light">{{ instancia.fecha }}</small>
                  </div>
                  <h4><a class="article-title">{{ instancia.nombre }}</a></h4>
                </div>
              </article>
            {% endfor %}
          </ul>
        </div>
        
      </div>
        
        <!-- Sección de Contenido de la Instancia -->
        <div class="col-md-6"  id="columna_contenido_instancias">
            <div class="content-section" id = "content-section_intancias" >
                <!--<h3 id="nombre_instancia">Nombre</h3>-->
                
                <form action="" method="POST">
                  {{ form_mod_instancia.csrf_token() }}
                  <fieldset class="form-group" style="height: 100%;">
                    <div class="form-group">
                      <input type="text" readonly class="form-control-plaintext" id="nombre_instancia" style="font-size: 1.75rem; font-weight: bold;" value="<Nombre>">
                    </div>

                    <div class="form-group"  id = "form_group_contenido">
                      {{ form_mod_instancia.contenido.label(class="formcontrol-label") }}
                      {{ form_mod_instancia.contenido(id="contenido_instancia", style="height:80%; resize: none;", class="form-control") }}
                    </div>
                    <div class="form-group">
                      {{ form_mod_instancia.modificar_btn(class="btn btn-outline-info") }}
                    </div>
                    <div class="form-group">
                      {{ form_mod_instancia.identificador(id="identificador_seleccionado", class="d-none")}}
                    </div>
                  </fieldset>
                </form>
            </div>
        </div>
        <!-- Botones -->
        <div class="col-md-2">
          <ul class="list-group">
              <a type="button" href="/add_instancias" class="btn btn-primary mb-2" data-bs-toggle="tooltip" title="Se irá al menú para crear una nueva instancia" >Nueva</a>
              <!--Ejecución del modelo-->
              <form id="probar_modelo_form" method="POST" action="">
                <input type="hidden" name="id_instancia_a_probar" id="id_instancia_a_probar" value="">
                <button type="submit" class="btn btn-primary mb-2" style="width:100%;" name="probar_btn" id="probar_btn" data-bs-toggle="tooltip" title="Probar la instancia con el modelo" disabled>Probar</button>
              </form>
              <button type="button" class="btn btn-primary mb-2" data-bs-toggle="tooltip" title="Se descargará el resultado la instancia" name="descargar_instancia_btn" id="descargar_instancia_btn" disabled>Descargar</button>
              <!-- Eliminación de instancias-->
              <button type="button" class="btn btn-danger mb-2" style="width:100%" data-bs-toggle="tooltip" title="Eliminar la instancia" name="eliminar_instancia_btn" id="eliminar_instancia_btn" disabled>Eliminar</button>
              <!--Detector de alertas-->
              {% for category, message in get_flashed_messages(with_categories=true) %}
              <div class="row">
                <!--<div class="alert alert-info" role = "alert" id="mensaje_flash">
                  {{ message }}
                </div>-->
                {% if category != 'warning'%}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'info' }}" role="alert" id="mensaje_flash_temporal_{{ loop.index }}">
                  {{ message }}
                </div>
                {% endif %}
              </div>
              {% endfor %}
          </ul>
        </div>
    </div>
    </div>
    <!--Detector de alertas-->
    <div class="row mt-1 ml-3">
      {% for category, message in get_flashed_messages(with_categories=true) %}
      <div class="row">
        <!--<div class="alert alert-info" role = "alert" id="mensaje_flash">
          {{ message }}
        </div>-->

        {% if category == 'warning'%}
        <div class="alert alert-{{ 'warning' if category == 'warning' else 'info' }}" role="alert" id="mensaje_flash_ejecucion">
          {{ message }}
        </div>
        {% endif %}
        
      </div>
      {% endfor %}
      <div id="flash_messages"></div> <!--Puesto por el front si ejecución-->
    </div>
    <div class="row mt-2" >
      <!--Modelo-->
      <div class="col-md-10">
        <div class="content-section p-0">
          <!--Informacion del modelo-->
          
            <div class="card">
              <div class="card-header h4 font-weight-bold">                
                Información del Modelo
              </div>
              <div class="card-body">
                <div class="row ml-1">    
                  <h4 class="card-title font-weight-bold" >Nombre Modelo: </h4> 
                  <h4 class="card-title" id="nombre_modelo"></h4>
                </div>
                <div class="row ml-1">    
                  <p class="card-text font-weight-bold">Fecha de creación: <span id="fecha-creacion"></span></p>
                  <p class="card-text" id="fecha_modelo"></p>
                </div>
                <div class="row ml-1">    
                  <p class="card-text font-weight-bold"> Duración: </p>
                  <p class="card-text" id="duracion_modelo"></p>
                </div>
                <div class="row ml-1">    
                  <p class="card-text font-weight-bold">Objetos seleccionados: </p>
                  <p class="card-text" id="objetos_seleccionados_modelo"></p>
                </div>
                <div class="row ml-1">    
                  <p class="card-text font-weight-bold">Instante de su seleccion: </p>
                  <p class="card-text" id="momentos_seleccionados_modelo"></p>
                </div>
                <div class="row ml-1">    
                  <p class="card-text font-weight-bold">Contenido:</p>
                </div>          
                <textarea class="form-control" id="contenido_modelo" rows="10" readonly style="font-family: monospace; resize: none" min-height = "300px"></textarea>
              </div>
            </div>
          

        </div>
      </div>
      <!--Botones del modelo-->
      <div class="col-md-2">
        <ul class="list-group">
            <button type="button" class="btn btn-primary mb-2" id="descargar_modelo_btn" data-bs-toggle="tooltip" title="Se descargará el resultado del modelo" disabled>Descargar</button>
            <button type="button" class="btn btn-danger mb-2" id="eliminar_modelo_btn" data-bs-toggle="tooltip" title="Se eliminará el resultado del modelo" disabled>Eliminar</button>
            <button type="button" class="btn btn-danger mb-2" id="mostrar_grafica_modelo_btn"  data-bs-toggle="modal" data-bs-target="#grafico_modal"
             title="Se mostrará una gráfica con los objetos seleccionados del modelo" disabled>Gráfica</button>
        </ul>
      </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="grafico_modal" tabindex="-1" aria-labelledby="graficoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="graficoModalLabel">Gráfica de Ejemplo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <canvas id="miGrafica" width="400" height="300"></canvas>
      </div>
    </div>
  </div>
</div>



<script type="text/javascript">
  var logs = {{ logs|tojson }};
  var modelo_seleccionado_actualmente;
</script>

<!-- Pasar la variable 'instancias' al cliente como JSON -->
<script type="text/javascript">
  
  
  function seleccionarInstancia(instancia) {
    
    // Actualizar el contenido del formulario
    document.getElementById("id_instancia_a_probar").value = instancia._id; 
    document.getElementById("identificador_seleccionado").value = instancia._id; 
    //document.getElementById("nombre_instancia").textContent = instancia.nombre; //Probablemente modifique la etiqueta de nombre y por ende esta linea de aquí
    document.getElementById("nombre_instancia").value = instancia.nombre;
    document.getElementById("contenido_instancia").value = JSON.stringify(instancia.contenido, null, 2); 
    // modificamos el valor en caso de querer probar la instancia
    //Activamos la opción de que se pueda eliminar la instancia
    document.getElementById("probar_btn").disabled = false;
    document.getElementById("eliminar_instancia_btn").disabled = false;
    document.getElementById("descargar_instancia_btn").disabled = false;
    document.getElementById("descargar_modelo_btn").disabled = false;
    document.getElementById("eliminar_modelo_btn").disabled = false;
    document.getElementById("mostrar_grafica_modelo_btn").disabled = false;
    
    
    //Buscamos si existe un log ya con el contenido
    modelo_seleccionado_actualmente = logs.find(function(seleccionado) {
      return seleccionado.instancia_id === instancia._id; 
    }); 
    
    
    if (modelo_seleccionado_actualmente) {
      //logElemento.style.display = 'block';
      document.getElementById("nombre_modelo").textContent = modelo_seleccionado_actualmente.nombre;
      document.getElementById("fecha_modelo").textContent = modelo_seleccionado_actualmente.fecha;
      document.getElementById("duracion_modelo").textContent = modelo_seleccionado_actualmente.valor_beneficio;
    
      document.getElementById("objetos_seleccionados_modelo").textContent= modelo_seleccionado_actualmente.objetos_seleccionados;
      document.getElementById("momentos_seleccionados_modelo").textContent= modelo_seleccionado_actualmente.momento_seleccionado;
      document.getElementById("contenido_modelo").value= modelo_seleccionado_actualmente.resumen_contenido;

    } else {
      document.getElementById("nombre_modelo").textContent = "<No se ha ejecutado el modelo para esta instancia>";
      document.getElementById("fecha_modelo").textContent = "";
      document.getElementById("duracion_modelo").textContent = "";

    
      document.getElementById("objetos_seleccionados_modelo").textContent= "";
      document.getElementById("momentos_seleccionados_modelo").textContent= "";
      document.getElementById("contenido_modelo").value= "";
      document.getElementById("descargar_modelo_btn").disabled = true;
      document.getElementById("eliminar_modelo_btn").disabled = true;
      document.getElementById("mostrar_grafica_modelo_btn").disabled = true;
    }
  }
  
</script>

<!--Evento para eliminar instancias-->
<script>
  document.getElementById('eliminar_instancia_btn').addEventListener('click', function() {
      const id = document.getElementById('identificador_seleccionado').value;
      const newUrl = `{{ url_for('eliminar_instancia', id='') }}${id}`;
      window.location.href = newUrl;
  });
</script>
<!--Evento descargar instancia-->

<!--Evento para eliminar modelos-->
<script>
  document.getElementById('eliminar_modelo_btn').addEventListener('click', function() {
      const id = document.getElementById('identificador_seleccionado').value;
      const newUrl = `{{ url_for('eliminar_modelo', id='') }}${id}`;
      window.location.href = newUrl;
  });
</script>


<script>//REVISAR
  document.getElementById('descargar_instancia_btn').addEventListener('click', function() {
    //obtenemos nombre y contenido de la instancia seleccionada
    nombre = document.getElementById('nombre_instancia').value
    contenido = document.getElementById("contenido_instancia").value
    
    // Crear un objeto Blob con el contenido
    var blob = new Blob([contenido], { type: 'text/plain' });

    // Crear un objeto URL para el Blob
    var url = URL.createObjectURL(blob);

    // Crear un enlace <a> para descargar el archivo
    var a = document.createElement('a');
    a.href = url;
    a.download = nombre + '.txt'; // Nombre del archivo a descargar

    // Agregar el enlace al documento y hacer clic en él para descargar
    document.body.appendChild(a);
    a.click();

    // Limpiamos después de la descarga
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  
  });
</script>

<script>
  document.getElementById('descargar_modelo_btn').addEventListener('click', function() {
    //obtenemos nombre y contenido de la instancia seleccionada
    nombre = document.getElementById('nombre_modelo').textContent
    contenido = document.getElementById("contenido_modelo").value
    
    // Crear un objeto Blob con el contenido
    var blob = new Blob([contenido], { type: 'text/plain' });

    // Crear un objeto URL para el Blob
    var url = URL.createObjectURL(blob);

    // Crear un enlace <a> para descargar el archivo
    var a = document.createElement('a');
    a.href = url;
    a.download = nombre + '.txt'; // Nombre del archivo a descargar

    // Agregar el enlace al documento y hacer clic en él para descargar
    document.body.appendChild(a);
    a.click();

    // Limpiamos después de la descarga
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  
  });
</script>

<!--Está atento a los mensajes, para los que posean el id mensaje_flash los muestre de manera temporal-->
<script>
  window.onload = function() {
    // Selecciona el mensaje flash
    
    //var flashMessage = document.getElementById('mensaje_flash_temporal');
    var flashMessages = document.querySelectorAll('[id^="mensaje_flash_temporal_"]');
    
    flashMessages.forEach(function(flashMessage) {
      // Oculta cada mensaje después de 2 segundos (2000 ms)
      setTimeout(function() {
          flashMessage.classList.add('hidden');
      }, 6000);

      // Elimina cada mensaje del DOM después de la transición
      setTimeout(function() {
          flashMessage.parentNode.removeChild(flashMessage);
      }, 6500); // 3000 ms + 500 ms para la transición
    });
    //Buscamos notificación de finalización del modelo
    var messagefinalizacion = document.getElementById('mensaje_flash_temporal');
  };
</script>

<!--Evento al pulsar el botón de probar el modelo-->

<script>
  document.getElementById('probar_btn').addEventListener('click', function(event) {
      // Evitar el envío del formulario para pruebas
      //event.preventDefault();

      // Desactivar el botón temporalmente cuidado, no se puede enviar el formulario si el botón se encuentra disabled.
      //document.getElementById("probar_btn").disabled = true;

      // Generar el mensaje flash
      const flashContainer = document.getElementById('flash_messages');
      const flashMessage = document.createElement('div');
      flashMessage.className = 'alert alert-info';
      flashMessage.role = 'alert';
      flashMessage.id = 'mensaje_flash_ejecutandose';
      flashMessage.innerText = 'Se está ejecutando el modelo, puede tardar varios minutos, por favor sea paciente';

      flashContainer.appendChild(flashMessage);
  });
</script>


<!-- Script para crear la gráfica cuando se abre el modal 
<script>
  let graficaInicializada = false;

  const modal = document.getElementById('grafico_modal');
  modal.addEventListener('shown.bs.modal', function () {
    if (!graficaInicializada) {
      const ctx = document.getElementById('miGrafica').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'],
          datasets: [{
            label: 'Ventas',
            data: [12, 19, 3, 5, 2],
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
      graficaInicializada = true;
    }
  });
</script>
-->

<script>
  
  // Datos 
  
  
  /*var modelo_actualmente_seleccionado = logs.find(function(seleccionado) {
    return seleccionado.instancia_id === id_instancia; 
  }); 
  
  if (!modelo_seleccionado_actualmente) {
    return ;
  }*/
  //modelo_actualmente_seleccionado = logs.find(log => log._id === document.getElementById('identificador_seleccionado').value);

  
  
  
  //modelo_actualmente_seleccionado = logs.find(log => log._id === document.getElementById('identificador_seleccionado').value);
  /*const objetos_seleccionados = logs["objetos_seleccionados"];
  const momentos = logs["momento_seleccionado"];
  document.getElementById("nombre_modelo").textContent = log.nombre;
  
  
  
  
  /*
  
  // Convertimos en datos para Chart.js
  const datos = objetos_seleccionados.map((obj, index) => ({
      x: momentos[index],
      y: obj
  }));
  /*
  const config = {
      type: 'scatter',
      data: {
          datasets: [{
              label: 'Objeto vs Momento',
              data: datos,
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
          }]
      },
      options: {
          scales: {
              x: {
                  title: {
                      display: true,
                      text: 'Momento Seleccionado'
                  }
              },
              y: {
                  title: {
                      display: true,
                      text: 'Objeto Seleccionado'
                  },
                  ticks: {
                      precision: 0
                  }
              }
          }
      }
  };

  */
  let graficaInicializada = false;
  // evento que para detectar
  const modal = document.getElementById('grafico_modal');
  modal.addEventListener('shown.bs.modal', function () {
    if (!graficaInicializada) {
      document.getElementById("graficoModalLabel").textContent = "Probando: " + modelo_seleccionado_actualmente.nombre;
      const objetos_seleccionados = modelo_seleccionado_actualmente["objetos_seleccionados"];
      const momentos = modelo_seleccionado_actualmente["momento_seleccionado"];

        // Convertimos en datos para Chart.js
      const datos = objetos_seleccionados.map((obj, index) => ({
        x: momentos[index],
        y: obj
      }));

      const config = {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Objeto vs Momento',
                data: datos,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
            }]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Momento Seleccionado'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Objeto Seleccionado'
                    },
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
      };
      new Chart(document.getElementById('miGrafica'), config);
      /*const ctx = document.getElementById('miGrafica').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'],
          datasets: [{
            label: 'Ventas',
            data: [12, 19, 3, 5, 2],
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });*/
      graficaInicializada = true;
    }
  });
</script>




<!-- Bootstrap CSS Me gustan algunos cambios otros no, ya miraré en el futuro una hoja de estilo
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
-->

<!-- Bootstrap JS Bundle (con Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</html>
{% endblock content %}