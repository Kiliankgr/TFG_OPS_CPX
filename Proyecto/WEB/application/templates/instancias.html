{% extends "layout.html" %}
{% block content %}
<!-- Evitamos que se muestre radio pero manteniendo la funcionalidad (hovering del elemento seleccionado) -->
<style>
  input[type="radio"] {
      display: none;
  }

  /* Estilos para el contenedor con desplazamiento */
  #columna_instancias {
      max-height: 500px; /* Ajusta esta altura según sea necesario */
      overflow-y: auto;
  }

  #columna_contenido_instancias {
    overflow-y: auto;
  }
</style>

<div class="container mt-5">
    <h2 class="mb-4">Instancias</h2>
    <div class="row">
        <div class="col-md-4" id="columna_instancias">
          <div class="btn-group btn-group-toggle" data-toggle="buttons" style="width:100%">
            <ul class="list-group" style="width:100%">
              {% for instancia in instancias %}
                <!--Transformamos el diccionario de la instancia a JSON, <ignorar aviso de error>-->
                <article class="btn btn-info active mb-2" id="instancia_elemento" onclick='seleccionarInstancia({{ instancia | tojson | safe }})'>
                  <input type="radio" name="options" autocomplete="off">
                  <div class="media-body">
                    <div class="article-metadata">                              
                      <small class="text-light">{{ instancia.fecha }}</small>
                    </div>
                    <h2><a class="article-title">{{ instancia.nombre }}</a></h2>
                  </div>
                </article>
              {% endfor %}
            </ul>
          </div>
        </div>
        <!-- Sección de Contenido de la Instancia -->
        <div class="col-md-6" id="columna_contenido_instancias">
            <div class="content-section" id = "content-section_intancias" >
                <!--<h3 id="nombre_instancia">Nombre</h3>-->
                
                <form action="" method="POST">
                  {{ form_mod_instancia.csrf_token() }}
                  <fieldset class="form-group">
                    <div class="form-group">
                      <input type="text" readonly class="form-control-plaintext" id="nombre_instancia" style="font-size: 1.75rem; font-weight: bold;" value="<Nombre>">
                    </div>

                    <div class="form-group" style="height:100%;">
                      {{ form_mod_instancia.contenido.label(class="formcontrol-label") }}
                      {{ form_mod_instancia.contenido(id="contenido_instancia", style="height:80%", class="form-control") }}
                    </div>
                    <div class="form-group">
                      {{ form_mod_instancia.modificar_btn(class="btn btn-outline-info") }}
                    </div>
                    <div class="form-group">
                      {{ form_mod_instancia.identificador(id="identificador_seleccionado", class="d-none")}}
                    </div>
                  </fieldset>
                </form>
            </div>
        </div>
        <!-- Botones -->
        <div class="col-md-2">
          <ul class="list-group">
              <a type="button" href="/add_instancias" class="btn btn-primary mb-2" data-bs-toggle="tooltip" title="Se irá al menú para crear una nueva instancia" >Nueva</a>
              <!--Ejecución del modelo-->
              <form id="probar_modelo_form" method="POST" action="">
                <input type="hidden" name="id_instancia_a_probar" id="id_instancia_a_probar" value="">
                <button type="submit" class="btn btn-primary mb-2" style="width:100%;" name="probar_btn" id="probar_btn" data-bs-toggle="tooltip" title="Probar la instancia con el modelo" disabled>Probar</button>
              </form>
              <button type="button" class="btn btn-primary mb-2" data-bs-toggle="tooltip" title="Se descargará el resultado la instancia" name="descargar_instancia_btn" id="descargar_instancia_btn" disabled>Descargar</button>
              <!-- Eliminación de instancias-->
              <button type="button" class="btn btn-danger mb-2" style="width:100%" data-bs-toggle="tooltip" title="Eliminar la instancia" name="eliminar_instancia_btn" id="eliminar_instancia_btn" disabled>Eliminar</button>
              <!--Detector de alertas-->
              {% for category, message in get_flashed_messages(with_categories=true) %}
              <div class="row">
                <!--<div class="alert alert-info" role = "alert" id="mensaje_flash">
                  {{ message }}
                </div>-->
                {% if category != 'warning'%}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'info' }}" role="alert" id="mensaje_flash_temporal_{{ loop.index }}">
                  {{ message }}
                </div>
                {% endif %}
              </div>
              {% endfor %}
          </ul>
        </div>
    </div>
    <!--Detector de alertas-->
    <div class="row mt-1 ml-3">
      {% for category, message in get_flashed_messages(with_categories=true) %}
      <div class="row">
        <!--<div class="alert alert-info" role = "alert" id="mensaje_flash">
          {{ message }}
        </div>-->

        {% if category == 'warning'%}
        <div class="alert alert-{{ 'warning' if category == 'warning' else 'info' }}" role="alert" id="mensaje_flash_ejecucion">
          {{ message }}
        </div>
        {% endif %}
        
      </div>
      {% endfor %}
      <div id="flash_messages"></div> <!--Puesto por el front si ejecución-->
    </div>
    <div class="row mt-2" >
      <!--Modelo-->
      <div class="col-md-10">
        <div class="content-section">
          <!--Informacion del modelo-->
          
            <div class="card">
              <div class="card-header h4 font-weight-bold">                
                Información del Modelo
              </div>
              <div class="card-body">
                <div class="row ml-1">    
                  <h4 class="card-title font-weight-bold">Nombre Modelo: </h4> <p class="card-text"></p>
                  <h4 class="card-title" id="nombre_modelo">a</h4>
                </div>
                <div class="row ml-1">    
                  <p class="card-text font-weight-bold">Fecha de creación: <span id="fecha-creacion"></span></p>
                  <p class="card-text" id="fecha_modelo">a</p>
                </div>
                <div class="row ml-1">    
                  <p class="card-text font-weight-bold">Contenido:</p>
                </div>          
                <textarea class="form-control" id="contenido_modelo" rows="10" readonly></textarea>
              </div>
            </div>
          

        </div>
      </div>
      <!--Botones del modelo-->
      <div class="col-md-2">
        <ul class="list-group">
            <button type="button" class="btn btn-primary mb-2" id="descargar_modelo_btn" data-bs-toggle="tooltip" title="Se descargará el resultado del modelo" disabled>Descargar</button>
            <button type="button" class="btn btn-danger mb-2" id="eliminar_modelo_btn" data-bs-toggle="tooltip" title="Se eliminará el resultado del modelo" disabled>Eliminar</button>
        </ul>
      </div>
    </div>
</div>




<!-- Pasar la variable 'instancias' al cliente como JSON -->
<script type="text/javascript">
  var logs = {{ logs|tojson }};

  function seleccionarInstancia(instancia) {
    
    // Actualizar el contenido del formulario
    document.getElementById("id_instancia_a_probar").value = instancia._id; 
    document.getElementById("identificador_seleccionado").value = instancia._id; 
    //document.getElementById("nombre_instancia").textContent = instancia.nombre; //Probablemente modifique la etiqueta de nombre y por ende esta linea de aquí
    document.getElementById("nombre_instancia").value = instancia.nombre;
    document.getElementById("contenido_instancia").value = JSON.stringify(instancia.contenido, null, 2); 
    // modificamos el valor en caso de querer probar la instancia
    //Activamos la opción de que se pueda eliminar la instancia
    document.getElementById("probar_btn").disabled = false;
    document.getElementById("eliminar_instancia_btn").disabled = false;
    document.getElementById("descargar_instancia_btn").disabled = false;
    document.getElementById("descargar_modelo_btn").disabled = false;
    document.getElementById("eliminar_modelo_btn").disabled = false;
    
    //Buscamos si existe un log ya con el contenido
    var log = logs.find(function(log) {
      return log.instancia_id === instancia._id;
    });
    
    if (log) {
      //logElemento.style.display = 'block';
      document.getElementById("nombre_modelo").textContent = log.nombre;
      document.getElementById("fecha_modelo").textContent = instancia._id;
    // Actualizar el elemento con el contenido del log, si se encuentra
      document.getElementById("contenido_modelo").value=JSON.stringify(log, null, 2); 
    } else {
      logElemento.style.display = 'none';
    }
    
  }
</script>

<!--Evento para eliminar instancias-->
<script>
  document.getElementById('eliminar_instancia_btn').addEventListener('click', function() {
      const id = document.getElementById('identificador_seleccionado').value;
      const newUrl = `{{ url_for('eliminar_instancia', id='') }}${id}`;
      window.location.href = newUrl;
  });
</script>
<!--Evento descargar instancia-->

<!--Evento para eliminar modelos-->
<script>
  document.getElementById('eliminar_modelo_btn').addEventListener('click', function() {
      const id = document.getElementById('identificador_seleccionado').value;
      const newUrl = `{{ url_for('eliminar_modelo', id='') }}${id}`;
      window.location.href = newUrl;
  });
</script>


<script>//REVISAR
  document.getElementById('descargar_instancia_btn').addEventListener('click', function() {
    //obtenemos nombre y contenido de la instancia seleccionada
    nombre = document.getElementById('nombre_instancia').value
    contenido = document.getElementById("contenido_instancia").value
    
    // Crear un objeto Blob con el contenido
    var blob = new Blob([contenido], { type: 'text/plain' });

    // Crear un objeto URL para el Blob
    var url = URL.createObjectURL(blob);

    // Crear un enlace <a> para descargar el archivo
    var a = document.createElement('a');
    a.href = url;
    a.download = nombre + '.txt'; // Nombre del archivo a descargar

    // Agregar el enlace al documento y hacer clic en él para descargar
    document.body.appendChild(a);
    a.click();

    // Limpiar después de la descarga
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  
  });
</script>

<!--Está atento a los mensajes, para los que posean el id mensaje_flash los muestre de manera temporal-->
<script>
  window.onload = function() {
    // Selecciona el mensaje flash
    
    //var flashMessage = document.getElementById('mensaje_flash_temporal');
    var flashMessages = document.querySelectorAll('[id^="mensaje_flash_temporal_"]');
    
    flashMessages.forEach(function(flashMessage) {
      // Oculta cada mensaje después de 2 segundos (2000 ms)
      setTimeout(function() {
          flashMessage.classList.add('hidden');
      }, 6000);

      // Elimina cada mensaje del DOM después de la transición
      setTimeout(function() {
          flashMessage.parentNode.removeChild(flashMessage);
      }, 6500); // 3000 ms + 500 ms para la transición
    });
    //Busamos notificación de finalización del modelo
    var messagefinalizacion = document.getElementById('mensaje_flash_temporal');
    /*if (flashMessage) {
          // Oculta el mensaje después de 2 segundos (2000 ms)
          setTimeout(function() {
              flashMessage.classList.add('hidden');
          }, 2000);

          // Elimina el mensaje del DOM después de la transición
          setTimeout(function() {
              flashMessage.parentNode.removeChild(flashMessage);
          }, 2500); // 2000 ms + 500 ms para la transición
      }*/
  };
</script>

<!--Evento al pulsar el botón de probar el modelo-->

<script>
  document.getElementById('probar_btn').addEventListener('click', function(event) {
      // Evitar el envío del formulario para pruebas
      //event.preventDefault();

      // Desactivar el botón temporalmente cuidado, no se puede enviar el formulario si el botón se encuentra disabled.
      //document.getElementById("probar_btn").disabled = true;

      // Generar el mensaje flash
      const flashContainer = document.getElementById('flash_messages');
      const flashMessage = document.createElement('div');
      flashMessage.className = 'alert alert-info';
      flashMessage.role = 'alert';
      flashMessage.id = 'mensaje_flash_ejecutandose';
      flashMessage.innerText = '(Front Quitar) Se está ejecutando el modelo, puede tardar varios minutos, por favor sea paciente';

      flashContainer.appendChild(flashMessage);
      /*
      // Opcional: Ocultar y eliminar el mensaje después de un tiempo
      setTimeout(function() {
          flashMessage.classList.add('hidden');
      }, 2000);

      setTimeout(function() {
          flashContainer.removeChild(flashMessage);
      }, 2500);*/

      // Si decides enviar el formulario después de mostrar el mensaje flash
      //document.getElementById('probar_modelo_form').submit();
  });
</script>


<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</html>
{% endblock content %}